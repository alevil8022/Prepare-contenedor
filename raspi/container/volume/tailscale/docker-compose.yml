version: "3.7"
services:
  # The Tailscale sidecar container
  ts-webserver:
    image: tailscale/tailscale:unstable
    hostname: raspi # The name in your Tailscale admin console
    environment:
      # Generate an auth key from your Tailscale admin console (Settings -> Keys)
      - TS_AUTHKEY=tskey-auth-xxxxxxxxx
      - TS_EXTRA_ARGS=--advertise-exit-node
      # Persist state so the container keeps its identity across restarts
      - TS_STATE_DIR=/var/lib/tailscale
      # Use kernel networking for full functionality (optional, userspace is default)
      - TS_USERSPACE=false 
    volumes:
      # Mount a volume for persistent state
      - tailscale-data:/var/lib/tailscale
      # Required to use kernel networking
      - /dev/net/tun:/dev/net/tun
    cap_add:
      # Required capabilities
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped

  # Your application container
  nginx-app:
    image: nginx:latest
    # This is the "magic" - it makes the nginx container share the tailscale network
    network_mode: service:ts-webserver
    restart: unless-stopped

# Define the volume for persistence
volumes:
  tailscale-data:
    driver: local

